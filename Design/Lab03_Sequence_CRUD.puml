@startuml Lab03_Sequence_CRUD
title Lab 03 - Layered Architecture: Product CRUD Operations

' Actors and Participants
actor Client as "API Client\n(Postman/Browser)"
participant Controller as "ProductController\n(Presentation Layer)"
participant Service as "ProductService\n(Business Logic Layer)"
participant Repository as "ProductRepository\n(Data Access Layer)"
database Database as "MySQL Database\n(products table)"

== CREATE Product (POST /api/lab03/products) ==

Client -> Controller: POST /api/lab03/products\n{name, price, category_id}
activate Controller

Controller -> Service: createProduct(data)
activate Service

Service -> Service: validateProductData(data)
note right
  Validation Rules:
  - Name: required, string
  - Price: required, >= 0
  - Category: exists in DB
end note

alt Validation Fails
    Service --> Controller: throw ValidationException
    Controller --> Client: 400 Bad Request\n{errors: [...]}
end

Service -> Service: applyBusinessRules(data)
note right
  Business Rules:
  - Calculate final price (price - discount)
  - Mark as "hot" if price > 10M
  - Auto-deactivate if stock = 0
end note

Service -> Repository: create(data)
activate Repository

Repository -> Repository: Generate slug\n(name + timestamp)
Repository -> Database: INSERT INTO products
activate Database
Database --> Repository: product_id, timestamps
deactivate Database

Repository --> Service: Product model
deactivate Repository

Service -> Service: transformProductData(product)
Service --> Controller: product_array
deactivate Service

Controller --> Client: 201 Created\n{success: true, data: {...}}
deactivate Controller

== READ Product (GET /api/lab03/products/{id}) ==

Client -> Controller: GET /api/lab03/products/1
activate Controller

Controller -> Service: getProductById(1)
activate Service

Service -> Repository: findById(1)
activate Repository

Repository -> Database: SELECT * FROM products WHERE id = 1
activate Database
Database --> Repository: product_row
deactivate Database

alt Product Not Found
    Repository --> Service: null
    Service --> Controller: throw Exception(404)
    Controller --> Client: 404 Not Found
else Product Found
    Repository --> Service: Product model
    deactivate Repository
    
    Service -> Service: transformProductData(product)
    Service --> Controller: product_array
    deactivate Service
    
    Controller --> Client: 200 OK\n{success: true, data: {...}}
end
deactivate Controller

== UPDATE Product (PUT /api/lab03/products/{id}) ==

Client -> Controller: PUT /api/lab03/products/1\n{name: "Updated Name"}
activate Controller

Controller -> Service: updateProduct(1, data)
activate Service

Service -> Repository: exists(1)
activate Repository
Repository -> Database: SELECT COUNT(*) WHERE id = 1
activate Database
Database --> Repository: count
deactivate Database
Repository --> Service: true/false
deactivate Repository

alt Product Not Found
    Service --> Controller: throw Exception(404)
    Controller --> Client: 404 Not Found
end

Service -> Service: validateProductData(data, id)
Service -> Service: applyBusinessRules(data, id)

Service -> Repository: update(1, data)
activate Repository

Repository -> Repository: Update slug if\nname changed
Repository -> Database: UPDATE products\nSET ... WHERE id = 1
activate Database
Database --> Repository: affected_rows
deactivate Database

Repository --> Service: Updated Product
deactivate Repository

Service -> Service: transformProductData(product)
Service --> Controller: product_array
deactivate Service

Controller --> Client: 200 OK\n{success: true, data: {...}}
deactivate Controller

== DELETE Product (DELETE /api/lab03/products/{id}) ==

Client -> Controller: DELETE /api/lab03/products/1
activate Controller

Controller -> Service: deleteProduct(1)
activate Service

Service -> Repository: exists(1)
activate Repository
Repository -> Database: SELECT COUNT(*) WHERE id = 1
activate Database
Database --> Repository: count
deactivate Database
Repository --> Service: true
deactivate Repository

alt Product Not Found
    Service --> Controller: throw Exception(404)
    Controller --> Client: 404 Not Found
end

Service -> Repository: delete(1)
activate Repository

Repository -> Database: DELETE FROM products WHERE id = 1
activate Database
Database --> Repository: deleted
deactivate Database

Repository --> Service: true
deactivate Repository

Service --> Controller: true
deactivate Service

Controller --> Client: 200 OK\n{success: true,\nmessage: "deleted"}
deactivate Controller

== LIST Products (GET /api/lab03/products) ==

Client -> Controller: GET /api/lab03/products?per_page=15
activate Controller

Controller -> Service: getAllProducts(15)
activate Service

Service -> Repository: getAllPaginated(15)
activate Repository

Repository -> Database: SELECT * FROM products\nWHERE pro_active = 1\nORDER BY id DESC\nLIMIT 15 OFFSET 0
activate Database
Database --> Repository: products[]
deactivate Database

Repository --> Service: Paginated Collection
deactivate Repository

Service --> Controller: paginated_data
deactivate Service

Controller --> Client: 200 OK\n{success: true,\ndata: {products, pagination}}
deactivate Controller

@enduml
